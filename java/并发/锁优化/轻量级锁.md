# 轻量级锁

轻量级锁的本意在没有多线程竞争的前提下，减少传统的仲连击锁使用操作系统互斥量产生的性能消耗

它所在的环境是考虑到，绝大多数情况下，在整个同步的周期内都不存在竞争，减少传统的锁竞争使用互斥量的资源操作

## 上锁过程

代码进入同步块的时候，如果同步对象没有锁定，也就是对象头当中的锁标记为 01，虚拟机在当前线程的栈帧当中简历一个 Lock Record 的空间，这里面存放当前锁对象目前的 Mark Word 的拷贝

然后尝试 CAS 操作，把对象的 Mark Word 指向为这线程的 Lock Record 的指针。

如果成功，则这个线程就有了该对象的锁，那么该对象当中的锁标记会变成 00

如果失败，那么虚拟机会检查对象头当中的 Mark Word 是否指向当前线程的栈帧，如果是指向当前线程的，那么说明这个线程已经有了这个对象的锁，否则这个锁对象就被其它的线程占据了

如果有两条以上的线程来抢占一个锁，就会膨胀成重量级锁

## 释放锁过程

检查对象的 Mark Word 是否指向的是当前线程，如果是就使用 CAS 操作把对象头当中的 Mark Word 和线程的 Mark Word 替换回来

如果替换成功，那么整个同步过程就结束了，如果失败，说明有其它的线程尝试过获取该锁，那么就要在释放锁的同时，唤醒被挂起的线程
